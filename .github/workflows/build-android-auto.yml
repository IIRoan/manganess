name: Automated Android APK Build

on:
  push:
    branches:
      - main

jobs:
  build:
    name: EAS Build APK (Auto)
    runs-on: ubuntu-latest
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to your Expo account"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: bun install

      - name: Build Android APK
        id: build
        run: |
          echo "Starting EAS build..."
          BUILD_OUTPUT=$(eas build -p android --profile preview --non-interactive --json)
          echo "$BUILD_OUTPUT"

          # Extract the APK URL from the JSON output
          APK_URL=$(echo "$BUILD_OUTPUT" | jq -r '.[0].artifacts.buildUrl // empty')

          # Fallback: try to extract URL from text output if JSON parsing fails
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            APK_URL=$(echo "$BUILD_OUTPUT" | grep -o 'https://expo\.dev/artifacts/eas/[^[:space:]]*\.apk' | head -1)
          fi

          if [ -n "$APK_URL" ] && [ "$APK_URL" != "null" ]; then
            echo "APK_URL=$APK_URL" >> $GITHUB_OUTPUT
            echo "Build completed successfully!"
            echo "APK URL: $APK_URL"
          else
            echo "Failed to extract APK URL from build output"
            exit 1
          fi

      - name: Download APK
        if: steps.build.outputs.APK_URL != ''
        run: |
          echo "Downloading APK from: ${{ steps.build.outputs.APK_URL }}"
          curl -L -o manganess-android.apk "${{ steps.build.outputs.APK_URL }}"

          # Verify the file was downloaded
          if [ -f "manganess-android.apk" ]; then
            echo "APK downloaded successfully"
            ls -lh manganess-android.apk
          else
            echo "Failed to download APK"
            exit 1
          fi

      - name: Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: manganess-android-apk
          path: manganess-android.apk
          retention-days: 30

      - name: Add build summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## Build Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Android APK" >> $GITHUB_STEP_SUMMARY
            echo "The APK has been built and uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Download:** Check the artifacts section of this workflow run." >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.build.outputs.APK_URL }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Direct URL:** ${{ steps.build.outputs.APK_URL }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Android APK build failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
